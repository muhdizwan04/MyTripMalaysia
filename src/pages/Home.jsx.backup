import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Button } from '../components/ui/Button';
import { Card, CardContent } from '../components/ui/Card';
import { Search, MapPin, Compass, Utensils, ShoppingBag, Camera, ChevronRight, Star, User, DollarSign, Plus, Sparkles } from 'lucide-react';
import { useCurrency } from '../context/CurrencyContext';
import FeedPost from '../components/feed/FeedPost';
import CreatePostModal from '../components/feed/CreatePostModal';
import { FEED_POSTS } from '../lib/constants';

const VIRAL_SPOTS = [
    {
        id: 1,
        name: "Village Park Nasi Lemak",
        location: "Petaling Jaya",
        rating: 4.8,
        price: 25,
        image: "https://images.unsplash.com/photo-1574484284002-952d92456975?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
        tag: "Viral Food"
    },
    {
        id: 2,
        name: "Batu Caves Rainbow Stairs",
        location: "Selangor",
        rating: 4.6,
        price: 0,
        image: "https://images.unsplash.com/photo-1544013919-4bb5cb5b77ef?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
        tag: "Must Visit"
    },
    {
        id: 3,
        name: "Pavilion KL Mall",
        location: "Kuala Lumpur",
        rating: 4.8,
        price: 0,
        image: "https://images.unsplash.com/photo-1582037928769-181f2644ecb7?ixlib=rb-4.0.3&auto=format&fit=crop&w=500&q=80",
        tag: "Shopping"
    }
];

export default function Home() {
    const navigate = useNavigate();
    const { formatPrice } = useCurrency();
    const [showCreatePost, setShowCreatePost] = useState(false);
    const [searchQuery, setSearchQuery] = useState('');
    const [activeFilter, setActiveFilter] = useState('all'); // all, food, scenery
    const [selectedSpot, setSelectedSpot] = useState(null);

    const isSearching = searchQuery.trim().length > 0;

    // Filter posts based on search query and active filter
    const filteredPosts = FEED_POSTS.filter(post => {
        // Filter by type
        if (activeFilter !== 'all' && post.type !== activeFilter) {
            return false;
        }

        // Filter by search query (search in place name, location, description)
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            return (
                post.placeName.toLowerCase().includes(query) ||
                post.location.toLowerCase().includes(query) ||
                post.description.toLowerCase().includes(query) ||
                post.state.toLowerCase().includes(query)
            );
        }

        return true;
    });

    return (
        <div className="min-h-screen bg-batik pb-24">
            <div className="max-w-md mx-auto px-6 py-10">
                {/* Header / Search */}
                <header className="mb-10 space-y-6">
                    <div className="flex justify-between items-start">
                        <div className="space-y-1">
                            <h2 className="text-[10px] font-black uppercase tracking-[0.2em] text-primary">Explore</h2>
                            <h1 className="text-4xl font-black tracking-tighter text-foreground">Malaysia</h1>
                        </div>
                        <div onClick={() => navigate('/profile')} className="h-12 w-12 rounded-full bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center cursor-pointer hover:scale-105 transition-transform border-2 border-primary/20">
                            <User className="h-5 w-5 text-primary" />
                        </div>
                    </div>

                    <div className="relative group">
                        <div className="absolute inset-0 bg-gradient-to-r from-primary/20 to-primary/10 rounded-[28px] blur-xl group-focus-within:blur-2xl transition-all" />
                        <div className="relative bg-white rounded-[24px] px-6 py-4 flex items-center gap-4 shadow-lg border-2 border-white/50 group-focus-within:shadow-primary/10 transition-all">
                            <Search className="h-5 w-5 text-muted-foreground" />
                            <input
                                type="text"
                                value={searchQuery}
                                onChange={(e) => setSearchQuery(e.target.value)}
                                placeholder="Where to next?"
                                className="text-sm font-medium flex-1 outline-none bg-transparent placeholder:text-muted-foreground"
                            />
                        </div>
                    </div>
                </header>

                {/* Search Results - Show at top when searching */}
                {isSearching && (
                    <div className="mb-10">
                        <div className="flex items-center justify-between mb-4 px-1">
                            <h3 className="text-sm font-black">Search Results</h3>
                            <button
                                onClick={() => setSearchQuery('')}
                                className="text-xs font-bold text-primary hover:underline"
                            >
                                Clear
                            </button>
                        </div>

                        {filteredPosts.length > 0 ? (
                            <div className="space-y-6">
                                {filteredPosts.map((post) => (
                                    <FeedPost key={post.id} post={post} />
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-20 bg-muted/10 rounded-3xl">
                                <Search className="h-12 w-12 text-muted-foreground mx-auto mb-3 opacity-50" />
                                <p className="text-muted-foreground font-bold">No similar results found</p>
                                <p className="text-xs text-muted-foreground mt-1">Try different keywords or browse our feed below</p>
                            </div>
                        )}
                    </div>
                )}

                {/* Quick Actions - Hidden when searching */}
                {!isSearching && (
                    <div className="flex gap-3 mb-10 overflow-x-auto no-scrollbar pb-2">
                        {[
                            { icon: Compass, label: 'Plan Trip', path: '/trips/create' },
                            { icon: Utensils, label: 'Find Food', path: '/trips/create' },
                            { icon: ShoppingBag, label: 'Shopping', path: '/trips/create' },
                            { icon: Camera, label: 'Must Visit', path: '/trips/create' }
                        ].map((item, idx) => (
                            <div
                                key={idx}
                                onClick={() => navigate(item.path)}
                                className="shrink-0 bg-white rounded-[20px] px-5 py-4 flex flex-col items-center gap-2 cursor-pointer hover:shadow-lg transition-all border-2 border-white/50 min-w-[90px]"
                            >
                                <div className="h-10 w-10 rounded-2xl bg-primary/10 flex items-center justify-center">
                                    <item.icon className="h-5 w-5 text-primary" />
                                </div>
                                <span className="text-[9px] font-black tracking-widest text-[#1a1a1a]">{item.label}</span>
                            </div>
                        ))}
                    </div>
                )}

                {/* Explore by State - Hidden when searching */}
                {!isSearching && (
                    <div className="mb-10">
                        <div className="flex items-center justify-between mb-6 px-1">
                            <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-primary">Destinations</h3>
                            <span className="text-[10px] font-black text-muted-foreground uppercase">13 States</span>
                        </div>
                        <div className="flex gap-4 overflow-x-auto no-scrollbar pb-4 -mx-6 px-6">
                            {['Selangor', 'Kuala Lumpur', 'Penang', 'Perak', 'Malacca', 'Johor', 'Sabah'].map((state, idx) => (
                                <div
                                    key={idx}
                                    onClick={() => navigate('/trips/create', { state: { preSelectedState: state } })}
                                    className="shrink-0 w-32 group cursor-pointer"
                                >
                                    <div className="h-40 w-full rounded-[28px] overflow-hidden mb-3 relative shadow-lg group-hover:shadow-primary/20 transition-all border-2 border-white/50">
                                        <img
                                            src={`https://images.unsplash.com/photo-${idx % 2 === 0 ? '1548013146-72479768bbaa' : '1524231757912-21f4fe3a7200'}?auto=format&fit=crop&w=300&q=80`}
                                            alt={state}
                                            className="h-full w-full object-cover group-hover:scale-110 transition-transform duration-500"
                                        />
                                        <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-black/20 to-transparent" />
                                        <div className="absolute bottom-3 left-3 right-3">
                                            <p className="text-white text-xs font-black tracking-tight drop-shadow-lg">{state}</p>
                                        </div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                {/* Viral Spots */}
                <div className="mb-10">
                    <div className="flex items-center justify-between mb-6 px-1">
                        <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-primary">Trending Now</h3>
                        <ChevronRight className="h-4 w-4 text-muted-foreground" />
                    </div>
                    <div className="space-y-4">
                        {VIRAL_SPOTS.map((spot) => (
                            <Card key={spot.id} className="overflow-hidden cursor-pointer group border-2 border-white/50 hover:shadow-xl hover:shadow-primary/10 transition-all rounded-[28px]">
                                <CardContent className="p-0">
                                    <div className="flex gap-4">
                                        <div className="w-24 h-24 shrink-0 relative overflow-hidden">
                                            <img src={spot.image} alt={spot.name} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                                            <div className="absolute top-2 left-2 bg-primary/90 text-white text-[8px] font-black px-2 py-1 rounded-full uppercase">
                                                {spot.tag}
                                            </div>
                                        </div>
                                        <div className="flex-1 py-3 pr-4">
                                            <h4 className="font-black text-sm mb-1 tracking-tight">{spot.name}</h4>
                                            <div className="flex items-center gap-1 mb-2">
                                                <MapPin className="h-3 w-3 text-primary" />
                                                <span className="text-[10px] font-bold text-muted-foreground">{spot.location}</span>
                                            </div>
                                            <div className="flex items-center justify-between">
                                                <div className="flex items-center gap-1">
                                                    <Star className="h-3 w-3 fill-yellow-500 text-yellow-500" />
                                                    <span className="text-[11px] font-black">{spot.rating}</span>
                                                </div>
                                                {spot.price > 0 && (
                                                    <div className="flex items-center gap-1">
                                                        <DollarSign className="h-3 w-3 text-primary" />
                                                        <span className="text-[11px] font-black text-primary">{formatPrice(spot.price)}</span>
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                    </div>
                                </CardContent>
                            </Card>
                        ))}
                    </div>
                </div>

                {/* Community Feed Section */}
                <div className="mb-10">
                    <div className="flex items-center justify-between mb-6 px-1">
                        <div className="flex items-center gap-2">
                            <Sparkles className="h-4 w-4 text-primary animate-pulse" />
                            <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-primary">Community Feed</h3>
                        </div>
                        <span className="text-[10px] font-black text-muted-foreground uppercase">Food & Scenery</span>
                    </div>

                    {/* Filter Buttons */}
                    <div className="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-2">
                        <button
                            onClick={() => setActiveFilter('all')}
                            className={`shrink-0 px-4 py-2 rounded-full text-xs font-black uppercase tracking-wider transition-all ${activeFilter === 'all'
                                ? 'bg-primary text-white'
                                : 'bg-white text-muted-foreground border-2 border-muted/50 hover:border-primary/50'
                                }`}
                        >
                            All
                        </button>
                        <button
                            onClick={() => setActiveFilter('food')}
                            className={`shrink-0 px-4 py-2 rounded-full text-xs font-black uppercase tracking-wider flex items-center gap-2 transition-all ${activeFilter === 'food'
                                ? 'bg-orange-500 text-white'
                                : 'bg-white text-muted-foreground border-2 border-muted/50 hover:border-orange-300'
                                }`}
                        >
                            <Utensils className="h-3 w-3" />
                            Food
                        </button>
                        <button
                            onClick={() => setActiveFilter('scenery')}
                            className={`shrink-0 px-4 py-2 rounded-full text-xs font-black uppercase tracking-wider flex items-center gap-2 transition-all ${activeFilter === 'scenery'
                                ? 'bg-emerald-500 text-white'
                                : 'bg-white text-muted-foreground border-2 border-muted/50 hover:border-emerald-300'
                                }`}
                        >
                            <Camera className="h-3 w-3" />
                            Scenery
                        </button>
                    </div>

                    <div className="space-y-6">
                        {filteredPosts.map((post) => (
                            <FeedPost key={post.id} post={post} />
                        ))}
                    </div>

                    {filteredPosts.length === 0 && (
                        <div className="text-center py-20 bg-muted/10 rounded-3xl">
                            <Search className="h-12 w-12 text-muted-foreground mx-auto mb-3 opacity-50" />
                            <p className="text-muted-foreground font-bold">No posts found</p>
                            <p className="text-xs text-muted-foreground mt-1">Try adjusting your search or filters</p>
                        </div>
                    )}
                </div>
            </div>

            {/* Floating Create Post Button */}
            <button
                onClick={() => setShowCreatePost(true)}
                className="fixed bottom-24 right-6 h-16 w-16 rounded-full bg-gradient-to-br from-primary to-primary/80 text-white shadow-2xl shadow-primary/30 hover:scale-110 transition-transform flex items-center justify-center z-40"
            >
                <Plus className="h-8 w-8" />
            </button>

            {/* Create Post Modal */}
            <CreatePostModal
                isOpen={showCreatePost}
                onClose={() => setShowCreatePost(false)}
            />
        </div>
    );
}
